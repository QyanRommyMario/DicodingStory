import{precacheAndRoute,cleanupOutdatedCaches}from"workbox-precaching";import{registerRoute}from"workbox-routing";import{CacheFirst,NetworkFirst,StaleWhileRevalidate}from"workbox-strategies";import{CacheableResponsePlugin}from"workbox-cacheable-response";import{ExpirationPlugin}from"workbox-expiration";precacheAndRoute(self.__WB_MANIFEST),cleanupOutdatedCaches();const CACHE_NAME="dicoding-story-v6",RUNTIME_CACHE="runtime-cache-v6",essentialUrls=["/","/index.html","/offline.html","/manifest.json","/favicon.png","/icon192.png","/icon512.png"],isValidUrl=e=>{try{return new URL(e,self.location.origin),!0}catch{return!1}},safeCacheAdd=async(e,t)=>{try{if(!isValidUrl(t))return!1;const n=await fetch(t,{method:"GET",headers:{"Cache-Control":"no-cache"}});return!!n.ok&&(await e.put(t,n),!0)}catch(e){return!1}};self.addEventListener("install",(e=>{e.waitUntil(Promise.all([caches.open(CACHE_NAME).then((async e=>{(await Promise.allSettled(essentialUrls.map((t=>safeCacheAdd(e,t))))).filter((e=>"fulfilled"===e.status&&e.value)).length})),caches.open(RUNTIME_CACHE).then((async e=>{(await Promise.allSettled(["https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"].map((t=>safeCacheAdd(e,t))))).filter((e=>"fulfilled"===e.status&&e.value)).length}))])),self.skipWaiting()})),self.addEventListener("activate",(e=>{const t=[CACHE_NAME,RUNTIME_CACHE];e.waitUntil(Promise.all([caches.keys().then((e=>Promise.allSettled(e.map((e=>{if(!t.includes(e))return caches.delete(e)}))))),self.clients.claim()]))}));const getOfflineFallback=async e=>{const t=await caches.open(CACHE_NAME);return"document"===e.destination?await t.match("/offline.html")||await t.match("/index.html")||new Response("<h1>Offline</h1><p>Please check your connection</p>",{headers:{"Content-Type":"text/html"}}):"image"===e.destination&&await t.match("/icon192.png")||new Response("",{status:204})};async function syncStories(){try{const e=await self.clients.matchAll();if(0===e.length)return;e.forEach((e=>e.postMessage({type:"SYNC_STORIES",timestamp:Date.now()})))}catch(e){throw e}}async function syncAuth(){try{const e=await self.clients.matchAll();if(0===e.length)return;e.forEach((e=>e.postMessage({type:"SYNC_AUTH",timestamp:Date.now()})))}catch(e){throw e}}registerRoute((({request:e})=>"document"===e.destination),new NetworkFirst({cacheName:"documents",networkTimeoutSeconds:5,plugins:[new CacheableResponsePlugin({statuses:[0,200]}),new ExpirationPlugin({maxEntries:50,maxAgeSeconds:2592e3}),{handlerDidError:async({request:e})=>await getOfflineFallback(e),handlerWillRespond:async({response:e})=>200===e.status?e:await getOfflineFallback()}]})),registerRoute((({request:e})=>"style"===e.destination||"script"===e.destination||e.url.includes("/src/")||e.url.includes("/scripts/")),new StaleWhileRevalidate({cacheName:"static-assets",plugins:[new CacheableResponsePlugin({statuses:[0,200]}),new ExpirationPlugin({maxEntries:100,maxAgeSeconds:2592e3}),{handlerDidError:async()=>new Response("",{status:204})}]})),registerRoute((({request:e})=>"image"===e.destination),new CacheFirst({cacheName:"images",plugins:[new CacheableResponsePlugin({statuses:[0,200]}),new ExpirationPlugin({maxEntries:100,maxAgeSeconds:2592e3}),{handlerDidError:async({request:e})=>await getOfflineFallback(e)}]})),registerRoute((({url:e})=>"https://cdnjs.cloudflare.com"===e.origin),new CacheFirst({cacheName:"cdn-cache",plugins:[new CacheableResponsePlugin({statuses:[0,200]}),new ExpirationPlugin({maxEntries:50,maxAgeSeconds:31536e3}),{handlerDidError:async({request:e})=>new Response("",{status:204})}]})),registerRoute((({url:e})=>e.hostname.includes("dicoding")||e.pathname.startsWith("/api")),new NetworkFirst({cacheName:"api-cache",networkTimeoutSeconds:10,plugins:[new CacheableResponsePlugin({statuses:[0,200]}),new ExpirationPlugin({maxEntries:100,maxAgeSeconds:86400}),{handlerDidError:async({request:e})=>{const t=await caches.open("api-cache");return await t.match(e)||new Response(JSON.stringify({error:"Offline",cached:!1}),{status:503,headers:{"Content-Type":"application/json"}})}}]})),self.addEventListener("push",(e=>{let t={title:"Dicoding Story",options:{body:"Ada update baru untuk Anda!",icon:"/icon192.png",badge:"/favicon.png",tag:"dicoding-story-notification",requireInteraction:!1,data:{url:"/"},actions:[{action:"view",title:"Lihat Story",icon:"/favicon.png"},{action:"close",title:"Tutup"}],vibrate:[200,100,200]}};if(e.data)try{const n=e.data.json();t={title:n.title||t.title,options:{...t.options,body:n.body||n.message||t.options.body,icon:n.icon||t.options.icon,data:{url:n.url||"/",...n}}}}catch(n){try{const n=e.data.text();n&&(t.options.body=n)}catch(e){}}e.waitUntil(self.registration.showNotification(t.title,t.options).catch((e=>{})))})),self.addEventListener("notificationclick",(e=>{e.notification.close();const t=e.action,n=e.notification.data?.url||"/";"close"!==t&&e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then((e=>{for(const t of e)if(t.url.includes(n)&&"focus"in t)return t.focus();for(const t of e)if(t.url.includes(self.location.origin)&&"focus"in t)return t.focus().then((()=>t.navigate(n))).catch((()=>clients.openWindow(n)));return clients.openWindow(n)})).catch((e=>clients.openWindow(n).catch((e=>{})))))})),self.addEventListener("sync",(e=>{"sync-stories"===e.tag?e.waitUntil(syncStories().catch(console.error)):"sync-auth"===e.tag&&e.waitUntil(syncAuth().catch(console.error))})),self.addEventListener("message",(e=>{try{if("skipWaiting"!==e.data?.action&&"SKIP_WAITING"!==e.data?.type||self.skipWaiting(),"GET_VERSION"===e.data?.type){const t=e.ports?.[0];t&&t.postMessage({version:"v6.0",timestamp:Date.now()})}}catch(e){}})),self.addEventListener("error",(e=>{})),self.addEventListener("unhandledrejection",(e=>{e.preventDefault()})),self.addEventListener("fetch",(e=>{"GET"===e.request.method&&e.request.url.startsWith("http")&&e.respondWith(fetch(e.request).catch((async t=>{const n=await caches.match(e.request);return n||await getOfflineFallback(e.request)})))}));